<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="manifest" href="manifest.json"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#C41E3A">
  <meta property="og:title" content="آراء القراء | في قلب الجحيم">
  <meta property="og:description" content="اقرأ آراء القراء عن رواية في قلب الجحيم وشاركنا رأيك">
  <meta property="og:image" content="https://fii-qalb-aljahimm.vercel.app/assets/images/book-cover/Main Book Cover Image.jpeg">
  <meta property="og:url" content="https://fii-qalb-aljahimm.vercel.app/reviews.html">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="canonical" href="https://fii-qalb-aljahimm.vercel.app/reviews.html">
  <title>آراء القراء | في قلب الجحيم – حنين سعد حابس</title>
  <meta name="description" content="آراء وتقييمات قراء رواية في قلب الجحيم — شاركنا رأيك!">
  <link rel="stylesheet" href="css/variables.css"><link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/animations.css"><link rel="stylesheet" href="css/responsive.css">
  <style>
    .reviews-hero{min-height:30vh;display:flex;align-items:center;padding-top:var(--nav-height);text-align:center}
    .reviews-stats{display:flex;gap:var(--sp-lg);justify-content:center;margin-top:var(--sp-md);flex-wrap:wrap}
    .reviews-stat{text-align:center}
    .reviews-stat-num{font-family:var(--font-en-title);font-size:clamp(28px,4vw,42px);font-weight:700;background:var(--grad-gold);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .reviews-stat-label{font-family:var(--font-ar-ui);font-size:12px;color:var(--text-muted)}

    /* Form */
    .review-form-card{background:var(--grad-glass);border:1px solid rgba(212,175,55,0.15);border-radius:var(--r-lg);padding:var(--sp-xl);backdrop-filter:blur(12px);margin-bottom:var(--sp-2xl);max-width:700px;margin-left:auto;margin-right:auto}
    .review-form-card h2{font-family:var(--font-ar-title);font-size:var(--fs-h3);color:var(--text-primary);margin-bottom:var(--sp-md);text-align:center}

    /* Star Rating */
    .star-rating{display:flex;gap:6px;justify-content:center;margin-bottom:var(--sp-md);direction:ltr}
    .star-rating .star{font-size:32px;cursor:pointer;transition:all .2s;color:rgba(212,175,55,0.2);filter:grayscale(1)}
    .star-rating .star.active,.star-rating .star:hover{color:var(--gold);filter:none;transform:scale(1.15)}
    .star-rating .star:hover ~ .star{color:rgba(212,175,55,0.2);filter:grayscale(1);transform:scale(1)}

    /* Reviews List */
    .reviews-list{max-width:800px;margin:0 auto}
    .reviews-sort{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-lg);flex-wrap:wrap}
    .sort-btn{padding:8px 20px;border-radius:var(--r-full);font-family:var(--font-ar-ui);font-size:13px;color:var(--text-muted);background:rgba(212,175,55,0.05);border:1px solid rgba(212,175,55,0.1);cursor:pointer;transition:all .2s}
    .sort-btn.active,.sort-btn:hover{color:var(--gold);border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.1)}

    /* Review Card */
    .review-card{background:rgba(20,20,25,0.6);border:1px solid rgba(212,175,55,0.1);border-radius:var(--r-md);padding:var(--sp-lg);margin-bottom:var(--sp-md);backdrop-filter:blur(8px);transition:border-color .3s}
    .review-card:hover{border-color:rgba(212,175,55,0.25)}
    .review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-sm);flex-wrap:wrap;gap:8px}
    .review-author{display:flex;align-items:center;gap:12px}
    .review-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--crimson),var(--gold));display:flex;align-items:center;justify-content:center;font-family:var(--font-ar-title);font-size:18px;font-weight:700;color:#fff;flex-shrink:0}
    .review-name{font-family:var(--font-ar-title);font-size:16px;color:var(--text-primary)}
    .review-date{font-family:var(--font-en-ui);font-size:11px;color:var(--text-muted)}
    .review-stars{display:flex;gap:2px;font-size:16px;direction:ltr}
    .review-stars .on{color:var(--gold)}
    .review-stars .off{color:rgba(212,175,55,0.15)}
    .review-text{font-family:var(--font-ar-body);font-size:var(--fs-body);color:var(--text-secondary);line-height:1.9;margin-bottom:var(--sp-md)}

    /* Reactions */
    .review-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .reaction-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:var(--r-full);font-size:13px;color:var(--text-muted);background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.08);cursor:pointer;transition:all .2s;font-family:var(--font-en-ui)}
    .reaction-btn:hover,.reaction-btn.reacted{background:rgba(212,175,55,0.12);border-color:rgba(212,175,55,0.3);color:var(--gold)}
    .reaction-btn .emoji{font-size:16px}
    .reply-toggle{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:var(--r-full);font-size:13px;color:var(--text-muted);background:none;border:1px solid rgba(212,175,55,0.08);cursor:pointer;transition:all .2s;font-family:var(--font-ar-ui);margin-right:auto}
    .reply-toggle:hover{color:var(--gold);border-color:rgba(212,175,55,0.3)}

    /* Replies */
    .replies-section{margin-top:var(--sp-md);padding-top:var(--sp-sm);border-top:1px solid rgba(212,175,55,0.06)}
    .reply-card{padding:var(--sp-sm) var(--sp-md);margin-top:var(--sp-xs);background:rgba(212,175,55,0.03);border-radius:var(--r-sm);border-right:3px solid rgba(212,175,55,0.2)}
    .reply-header{display:flex;align-items:center;gap:8px;margin-bottom:4px}
    .reply-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,rgba(196,30,58,0.6),rgba(212,175,55,0.6));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
    .reply-name{font-family:var(--font-ar-title);font-size:13px;color:var(--gold)}
    .reply-date{font-size:10px;color:var(--text-muted);font-family:var(--font-en-ui)}
    .reply-text{font-family:var(--font-ar-body);font-size:14px;color:var(--text-secondary);line-height:1.7}

    /* Reply Form */
    .reply-form{display:flex;gap:8px;margin-top:var(--sp-sm);align-items:flex-end}
    .reply-form input{flex:1}
    .reply-form .reply-name-input{max-width:120px}
    .reply-form button{padding:10px 20px;white-space:nowrap}

    /* Empty State */
    .empty-reviews{text-align:center;padding:var(--sp-2xl) var(--sp-lg);color:var(--text-muted)}
    .empty-reviews .empty-icon{font-size:64px;margin-bottom:var(--sp-md);opacity:0.3}
    .empty-reviews p{font-family:var(--font-ar-ui);font-size:16px}

    /* Loading */
    .reviews-loading{text-align:center;padding:var(--sp-xl);color:var(--gold);font-family:var(--font-ar-ui)}
    .reviews-loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(212,175,55,0.2);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:var(--sp-sm)}

    /* Toast */
    .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:linear-gradient(145deg,#1E1E24,#141419);border:1px solid rgba(212,175,55,0.3);border-radius:var(--r-md);padding:14px 28px;font-family:var(--font-ar-ui);font-size:14px;color:var(--gold);z-index:1000;transition:transform .4s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    .toast.show{transform:translateX(-50%) translateY(0)}

    /* Media Toolbar */
    .media-toolbar{display:flex;gap:8px;margin-bottom:var(--sp-md);flex-wrap:wrap}
    .media-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r-full);font-family:var(--font-ar-ui);font-size:12px;color:var(--text-muted);background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.12);cursor:pointer;transition:all .2s}
    .media-btn:hover{color:var(--gold);border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.12)}
    .media-btn .ico{font-size:16px}

    /* Media Preview */
    .media-preview{margin-bottom:var(--sp-md);position:relative;display:inline-block}
    .media-preview img{max-width:200px;max-height:150px;border-radius:var(--r-sm);border:1px solid rgba(212,175,55,0.15)}
    .media-preview .remove-media{position:absolute;top:-8px;right:-8px;width:24px;height:24px;border-radius:50%;background:var(--crimson);color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none}

    /* GIF/Sticker Modal */
    .giphy-modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);z-index:2000;display:flex;align-items:center;justify-content:center;padding:var(--sp-lg);opacity:0;pointer-events:none;transition:opacity .3s}
    .giphy-modal.open{opacity:1;pointer-events:all}
    .giphy-box{background:linear-gradient(145deg,#1A1A20,#12121A);border:1px solid rgba(212,175,55,0.25);border-radius:var(--r-xl);padding:var(--sp-lg);max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column}
    .giphy-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-md)}
    .giphy-header h3{font-family:var(--font-ar-title);color:var(--gold);font-size:18px}
    .giphy-close{width:32px;height:32px;border-radius:50%;background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.2);color:var(--text-muted);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .giphy-search{width:100%;padding:10px 16px;background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.15);border-radius:var(--r-sm);color:var(--text-primary);font-family:var(--font-ar-ui);font-size:14px;margin-bottom:var(--sp-md);direction:rtl}
    .giphy-search::placeholder{color:var(--text-muted)}
    .giphy-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;overflow-y:auto;max-height:50vh;padding:4px}
    .giphy-grid img{width:100%;height:auto;border-radius:8px;cursor:pointer;transition:transform .2s;border:2px solid transparent}
    .giphy-grid img:hover{transform:scale(1.05);border-color:var(--gold)}

    /* Review Media Display */
    .review-media{margin:var(--sp-sm) 0}
    .review-media img{max-width:100%;max-height:400px;border-radius:var(--r-md);border:1px solid rgba(212,175,55,0.12)}
    .review-media .review-gif{max-width:300px}
    .review-media .review-sticker{max-width:120px}

    /* Edit/Delete Buttons */
    .review-owner-actions{display:flex;gap:6px;margin-right:auto}
    .owner-btn{padding:4px 12px;border-radius:var(--r-full);font-family:var(--font-ar-ui);font-size:11px;cursor:pointer;transition:all .2s;border:1px solid rgba(212,175,55,0.1);background:rgba(212,175,55,0.04);color:var(--text-muted)}
    .owner-btn:hover{border-color:rgba(212,175,55,0.3);color:var(--gold)}
    .owner-btn.delete-btn:hover{border-color:rgba(196,30,58,0.4);color:var(--crimson);background:rgba(196,30,58,0.08)}

    @media(max-width:768px){
      .review-form-card{padding:var(--sp-lg)}
      .review-header{flex-direction:column;align-items:flex-start}
      .reply-form{flex-direction:column}
      .reply-form .reply-name-input{max-width:100%}
      .reviews-stats{gap:var(--sp-md)}
      .giphy-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="bg-effects"><canvas id="particles-canvas"></canvas><div class="fog-layer"></div></div>
<nav class="main-nav scrolled" id="navbar">
  <div class="nav-container">
    <a href="index.html" class="logo">في قلب الجحيم</a>
    <button class="mobile-menu-toggle" id="menuToggle"><span></span><span></span><span></span></button>
    <ul class="nav-links">
      <li><a href="index.html">الرئيسية</a></li>
      <li><a href="about-book.html">عن الكتاب</a></li>
      <li><a href="characters.html">الشخصيات</a></li>
      <li><a href="gallery.html">المعرض</a></li>
      <li><a href="author.html">الكاتبة</a></li>
      <li><a href="reviews.html" class="active">آراء القراء</a></li>
      <li><a href="read.html" class="nav-read-btn">📖 اقرأ مقتطف</a></li>
      <li><a href="buy.html" class="btn btn-primary btn-sm" target="_blank">اشترِ الآن</a></li>
    </ul>
  </div>
</nav>
<div class="mobile-menu" id="mobileMenu"><a href="index.html">الرئيسية</a><a href="about-book.html">عن الكتاب</a><a href="characters.html">الشخصيات</a><a href="gallery.html">المعرض</a><a href="author.html">الكاتبة</a><a href="reviews.html">آراء القراء</a><a href="read.html">اقرأ مقتطف</a><a href="buy.html" target="_blank">اشترِ الآن</a></div>

<main>
<!-- HERO -->
<section class="reviews-hero">
  <div class="section-container" data-reveal>
    <span class="section-label">آراء القراء</span>
    <h1 style="font-family:var(--font-ar-title);font-size:var(--fs-h1);color:var(--text-primary);margin-bottom:var(--sp-sm)">ماذا قال القراء؟</h1>
    <p style="color:var(--text-muted);font-family:var(--font-ar-ui)">شاركنا رأيك في الرواية — كل صوت يُسمع هنا</p>
    <div class="reviews-stats" id="reviewsStats">
      <div class="reviews-stat">
        <div class="reviews-stat-num" id="totalReviews">0</div>
        <div class="reviews-stat-label">رأي</div>
      </div>
      <div class="reviews-stat">
        <div class="reviews-stat-num" id="avgRating">0</div>
        <div class="reviews-stat-label">متوسط التقييم</div>
      </div>
    </div>
  </div>
</section>

<!-- REVIEW FORM -->
<section style="padding:var(--sp-lg) 0">
  <div class="section-container">
    <div class="review-form-card" data-reveal>
      <h2>✍️ أضف رأيك</h2>
      <form id="reviewForm" onsubmit="submitReview(event)">
        <div class="form-group">
          <label class="form-label">اسمك</label>
          <input type="text" id="reviewName" class="form-input" placeholder="اكتب اسمك..." required maxlength="50">
        </div>
        <div class="form-group">
          <label class="form-label">تقييمك</label>
          <div class="star-rating" id="starRating">
            <span class="star" data-val="1" onclick="setRating(1)">⭐</span>
            <span class="star" data-val="2" onclick="setRating(2)">⭐</span>
            <span class="star" data-val="3" onclick="setRating(3)">⭐</span>
            <span class="star" data-val="4" onclick="setRating(4)">⭐</span>
            <span class="star" data-val="5" onclick="setRating(5)">⭐</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">رأيك في الرواية</label>
          <textarea id="reviewText" class="form-textarea" placeholder="اكتب رأيك هنا..." required maxlength="1000" style="min-height:100px"></textarea>
        </div>
        <!-- Media Toolbar -->
        <div class="media-toolbar">
          <button type="button" class="media-btn" onclick="document.getElementById('imageInput').click()"><span class="ico">📷</span> صورة</button>
          <button type="button" class="media-btn" onclick="openGiphy()"><span class="ico">🎬</span> GIF</button>
          <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="previewImage(this)">
        </div>
        <!-- Media Preview -->
        <div id="mediaPreview"></div>
        <button type="submit" class="btn btn-primary btn-large" style="width:100%;justify-content:center" id="submitBtn">
          إرسال رأيك 🔥
        </button>
      </form>
    </div>
  </div>
</section>

<!-- REVIEWS LIST -->
<section style="padding:0 0 var(--sp-2xl)">
  <div class="section-container">
    <div class="reviews-list" id="reviewsList">
      <div class="reviews-loading" id="reviewsLoading">
        <div class="spinner"></div>
        <p>جاري تحميل الآراء...</p>
      </div>
    </div>
  </div>
</section>
</main>

<footer class="main-footer"><div class="section-container">
  <div class="footer-grid">
    <div><h3 class="footer-logo">في قلب الجحيم</h3><p class="footer-description">رواية تحقيق جنائي</p><div class="social-links"><a href="https://www.facebook.com/hanean.hayes" target="_blank" class="social-link"><svg viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg></a><a href="https://www.instagram.com/hanean_saad_hayes" target="_blank" class="social-link"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/></svg></a></div></div>
    <div><h4 class="footer-heading">الصفحات</h4><ul class="footer-links-list"><li><a href="index.html">الرئيسية</a></li><li><a href="activities.html">فعاليات</a></li><li><a href="read.html">اقرأ مقتطفاً</a></li><li><a href="buy.html">اشترِ الآن</a></li></ul></div>
    <div><h4 class="footer-heading">المزيد</h4><ul class="footer-links-list"><li><a href="characters.html">الشخصيات</a></li><li><a href="author.html">الكاتبة</a></li><li><a href="gallery.html">المعرض</a></li></ul></div>
    <div><h4 class="footer-heading">اشترِ الآن</h4><p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">153 جنيه فقط</p><a href="buy.html" class="btn btn-primary">اشترِ الآن 🔥</a></div>
  </div>
  <div class="gold-line-h"></div>
  <div class="footer-bottom"><p class="footer-copyright">© 2026 في قلب الجحيم.</p><div class="khalid-credit"><div class="credit-icon">⚡</div><span>Built by </span><a href="https://www.instagram.com/kh23alid_hassan/?__pwa=1" target="_blank" style="color:var(--gold);text-decoration:none" class="credit-name">Khalid Hassan</a></div></div>
</div></footer>

<div class="toast" id="toast"></div>

<!-- GIPHY Modal -->
<div class="giphy-modal" id="giphyModal">
  <div class="giphy-box">
    <div class="giphy-header">
      <h3 id="giphyTitle">اختر GIF</h3>
      <button class="giphy-close" onclick="closeGiphy()">✕</button>
    </div>
    <input type="text" class="giphy-search" id="giphySearch" placeholder="ابحث عن GIF..." oninput="searchGiphy()">
    <div class="giphy-grid" id="giphyGrid"></div>
    <p style="text-align:center;margin-top:8px;font-size:10px;color:var(--text-muted)">Powered by GIPHY</p>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = 'https://mrtbmupvvgjjmvsoeiqq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ydGJtdXB2dmdqam12c29laXFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzQwNjMsImV4cCI6MjA4NzU1MDA2M30.USWgjw0Dvr7QK2-Q0fYmW9xAMdbfyXiFz6eHLEcD1Bk';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const GIPHY_KEY = 'qasXrKFPadI3y6vhWwttqfxggE8MF687';

let currentRating = 0, allReviews = [];
let pendingImage = null, pendingGif = null;
let giphyTimer = null;

// ── Own reviews identity ──
function getMyReviews() { return JSON.parse(localStorage.getItem('my_reviews') || '[]'); }
function addMyReview(id) { const m = getMyReviews(); m.push(id); localStorage.setItem('my_reviews', JSON.stringify(m)); }
function removeMyReview(id) { const m = getMyReviews().filter(x => x !== id); localStorage.setItem('my_reviews', JSON.stringify(m)); }
function isMyReview(id) { return getMyReviews().includes(id); }

// ── Rating ──
function setRating(val) {
  currentRating = val;
  document.querySelectorAll('#starRating .star').forEach((s, i) => s.classList.toggle('active', i < val));
}

// ── Image Upload ──
function previewImage(input) {
  if (!input.files[0]) return;
  const file = input.files[0];
  if (file.size > 1024 * 1024) { showToast('⚠️ الصورة كبيرة — الحد الأقصى 1MB'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    pendingImage = e.target.result;
    updateMediaPreview();
  };
  reader.readAsDataURL(file);
}

function updateMediaPreview() {
  const c = document.getElementById('mediaPreview');
  let html = '';
  if (pendingImage) html += `<div class="media-preview"><img src="${pendingImage}" alt="preview"><button class="remove-media" onclick="pendingImage=null;updateMediaPreview()">✕</button></div> `;
  if (pendingGif) html += `<div class="media-preview"><img src="${pendingGif}" alt="gif"><button class="remove-media" onclick="pendingGif=null;updateMediaPreview()">✕</button></div> `;
  c.innerHTML = html;
}

// ── GIPHY ──
function openGiphy() {
  document.getElementById('giphyTitle').textContent = '🎬 اختر GIF';
  document.getElementById('giphyModal').classList.add('open');
  document.getElementById('giphySearch').value = '';
  searchGiphy('horror'); // default search
}

function closeGiphy() { document.getElementById('giphyModal').classList.remove('open'); }

function searchGiphy(query) {
  clearTimeout(giphyTimer);
  const q = query || document.getElementById('giphySearch').value.trim() || 'كتاب';
  giphyTimer = setTimeout(async () => {
    const url = `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(q)}&limit=18&rating=g&lang=ar`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      const grid = document.getElementById('giphyGrid');
      grid.innerHTML = (data.data || []).map(g =>
        `<img src="${g.images.fixed_width_small.url}" data-full="${g.images.fixed_width.url}" alt="${g.title}" onclick="selectGiphy('${g.images.fixed_width.url}')" loading="lazy">`
      ).join('');
    } catch(e) { console.error(e); }
  }, 400);
}

function selectGiphy(url) {
  pendingGif = url;
  updateMediaPreview();
  closeGiphy();
}

// ── Submit Review ──
async function submitReview(e) {
  e.preventDefault();
  const name = document.getElementById('reviewName').value.trim();
  const text = document.getElementById('reviewText').value.trim();
  if (!name || !text) return;
  if (currentRating === 0) { showToast('⭐ اختار تقييمك الأول'); return; }
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = 'جاري الإرسال...';

  const payload = { name, text, rating: currentRating };
  if (pendingImage) payload.image_url = pendingImage;
  if (pendingGif) payload.gif_url = pendingGif;

  const { data, error } = await sb.from('reviews').insert(payload).select('id');
  if (error) { showToast('❌ ' + error.message); }
  else {
    if (data && data[0]) addMyReview(data[0].id);
    document.getElementById('reviewForm').reset();
    currentRating = 0; pendingImage = null; pendingGif = null;
    document.querySelectorAll('#starRating .star').forEach(s => s.classList.remove('active'));
    document.getElementById('mediaPreview').innerHTML = '';
    showToast('✅ تم إضافة رأيك بنجاح!');
    loadReviews();
  }
  btn.disabled = false; btn.textContent = 'إرسال رأيك 🔥';
}

// ── Load Reviews ──
async function loadReviews() {
  const { data: reviews, error } = await sb.from('reviews').select('*').order('created_at', { ascending: false });
  if (error) {
    document.getElementById('reviewsList').innerHTML = '<div class="empty-reviews"><p style="color:var(--crimson)">⚠️ ' + error.message + '</p></div>';
    return;
  }
  const ids = reviews.map(r => r.id);
  const { data: replies } = await sb.from('replies').select('*').in('review_id', ids.length ? ids : ['x']).order('created_at');
  allReviews = reviews.map(r => ({ ...r, replies: (replies||[]).filter(rep => rep.review_id === r.id) }));
  renderReviews(); updateStats();
}

// ── Render Reviews ──
function renderReviews() {
  const c = document.getElementById('reviewsList');
  if (!allReviews.length) { c.innerHTML = '<div class="empty-reviews"><div class="empty-icon">📝</div><p>مفيش آراء لسه — كن أول من يشارك رأيه!</p></div>'; return; }
  c.innerHTML = allReviews.map(r => {
    const d = new Date(r.created_at).toLocaleDateString('ar-EG',{year:'numeric',month:'short',day:'numeric'});
    const ur = JSON.parse(localStorage.getItem('rct_'+r.id)||'{}');
    const mine = isMyReview(r.id);
    let mediaHtml = '';
    if (r.image_url) mediaHtml += `<div class="review-media"><img src="${esc(r.image_url)}" alt="صورة مرفقة" loading="lazy"></div>`;
    if (r.gif_url) mediaHtml += `<div class="review-media"><img src="${esc(r.gif_url)}" alt="GIF" class="review-gif" loading="lazy"></div>`;
    if (r.sticker_url) mediaHtml += `<div class="review-media"><img src="${esc(r.sticker_url)}" alt="ملصق" class="review-sticker" loading="lazy"></div>`;
    return `<div class="review-card" id="rc-${r.id}">
      <div class="review-header"><div class="review-author"><div class="review-avatar">${r.name.charAt(0)}</div><div><div class="review-name">${esc(r.name)}</div><div class="review-date">${d}</div></div></div><div class="review-stars">${stars(r.rating)}</div></div>
      <div class="review-text" id="rtxt-${r.id}">${esc(r.text)}</div>
      ${mediaHtml}
      <div class="review-actions">
        <button class="reaction-btn ${ur.fire?'reacted':''}" onclick="react('${r.id}','fire')"><span class="emoji">🔥</span> ${r.fire||0}</button>
        <button class="reaction-btn ${ur.heart?'reacted':''}" onclick="react('${r.id}','heart')"><span class="emoji">❤️</span> ${r.heart||0}</button>
        <button class="reaction-btn ${ur.clap?'reacted':''}" onclick="react('${r.id}','clap')"><span class="emoji">👏</span> ${r.clap||0}</button>
        <button class="reply-toggle" onclick="toggleReply('${r.id}')">💬 رد (${r.replies?.length||0})</button>
        ${mine ? `<div class="review-owner-actions"><button class="owner-btn" onclick="editReview('${r.id}')">✏️ تعديل</button><button class="owner-btn delete-btn" onclick="deleteReview('${r.id}')">🗑️ حذف</button></div>` : ''}
      </div>
      <div class="replies-section" id="replies-${r.id}" style="display:${r.replies?.length?'block':'none'}">
        ${(r.replies||[]).map(rep=>`<div class="reply-card"><div class="reply-header"><div class="reply-avatar">${(rep.name||'?').charAt(0)}</div><span class="reply-name">${esc(rep.name||'مجهول')}</span><span class="reply-date">${new Date(rep.created_at).toLocaleDateString('ar-EG',{month:'short',day:'numeric'})}</span></div><div class="reply-text">${esc(rep.text)}</div></div>`).join('')}
        <div class="reply-form" id="replyForm-${r.id}" style="display:none">
          <input type="text" class="form-input reply-name-input" placeholder="اسمك" id="rn-${r.id}" maxlength="30">
          <input type="text" class="form-input" placeholder="اكتب ردك..." id="rt-${r.id}" maxlength="500">
          <button class="btn btn-primary btn-sm" onclick="submitReply('${r.id}')">رد</button>
        </div>
      </div></div>`;
  }).join('');
}

// ── Edit Review ──
async function editReview(id) {
  const r = allReviews.find(x => x.id === id);
  if (!r) return;
  const newText = prompt('عدّل رأيك:', r.text);
  if (newText === null || !newText.trim()) return;
  const { error } = await sb.from('reviews').update({ text: newText.trim() }).eq('id', id);
  if (error) showToast('❌ ' + error.message);
  else { showToast('✅ تم تعديل رأيك'); loadReviews(); }
}

// ── Delete Review ──
async function deleteReview(id) {
  if (!confirm('متأكد إنك عايز تمسح رأيك؟')) return;
  // Delete replies first
  await sb.from('replies').delete().eq('review_id', id);
  const { error } = await sb.from('reviews').delete().eq('id', id);
  if (error) showToast('❌ ' + error.message);
  else { removeMyReview(id); showToast('✅ تم حذف رأيك'); loadReviews(); }
}

function stars(n){let h='';for(let i=1;i<=5;i++)h+='<span class="'+(i<=n?'on':'off')+'">★</span>';return h;}
function esc(s){if(!s) return '';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

async function react(id,type) {
  const k='rct_'+id, ur=JSON.parse(localStorage.getItem(k)||'{}');
  if(ur[type]){showToast('عملت ريأكت ده قبل كده ✨');return;}
  const r=allReviews.find(x=>x.id===id);
  if(!r)return;
  const upd={};upd[type]=(r[type]||0)+1;
  await sb.from('reviews').update(upd).eq('id',id);
  ur[type]=true;localStorage.setItem(k,JSON.stringify(ur));
  loadReviews();
}

function toggleReply(id){
  const f=document.getElementById('replyForm-'+id);
  document.getElementById('replies-'+id).style.display='block';
  f.style.display=f.style.display==='none'?'flex':'none';
}

async function submitReply(id){
  const name=document.getElementById('rn-'+id).value.trim()||'مجهول';
  const text=document.getElementById('rt-'+id).value.trim();
  if(!text)return;
  const{error}=await sb.from('replies').insert({review_id:id,name,text});
  if(error){showToast('❌ '+error.message);}
  else{document.getElementById('rn-'+id).value='';document.getElementById('rt-'+id).value='';showToast('✅ تم إضافة ردك');loadReviews();}
}

function updateStats(){
  const t=allReviews.length;
  document.getElementById('totalReviews').textContent=t;
  if(t>0)document.getElementById('avgRating').textContent=(allReviews.reduce((s,r)=>s+(r.rating||0),0)/t).toFixed(1);
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

loadReviews();
</script>
<script src="js/particles.js"></script><script src="js/navigation.js"></script><script src="js/main.js"></script><script src="js/music-player.js"></script>
</body></html>